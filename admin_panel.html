<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sophia Bot - Admin Dashboard</title>
    
    <!-- âš¡ OTIMIZAÃ‡Ã•ES DE PERFORMANCE -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/chart.js" as="script">
    
    <!-- Carrega Chart.js de forma assÃ­ncrona -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            will-change: transform;
            transform: translateZ(0);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #667eea, #764ba2);
        }

        .stat-card.critical::before {
            background: linear-gradient(180deg, #f093fb, #f5576c);
        }

        .stat-card.success::before {
            background: linear-gradient(180deg, #4facfe, #00f2fe);
        }

        .stat-card.warning::before {
            background: linear-gradient(180deg, #ffd89b, #19547b);
        }

        .stat-label {
            font-size: 13px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-change {
            font-size: 13px;
            color: #4CAF50;
        }

        .stat-change.negative {
            color: #f44336;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            contain: layout;
        }

        .chart-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .table-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .table-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        td {
            padding: 15px 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.hot {
            background: #ffebee;
            color: #f44336;
        }

        .badge.warm {
            background: #fff3e0;
            color: #ff9800;
        }

        .badge.cold {
            background: #e3f2fd;
            color: #2196f3;
        }

        .badge.vip {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge.cooldown {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge.normal {
            background: #e3f2fd;
            color: #1976d2;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(102, 126, 234, 0.4);
        }

        .alert {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert.danger {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .alert.success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .insights {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .insight-item {
            padding: 15px;
            border-left: 3px solid #667eea;
            margin-bottom: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }

        .insight-item strong {
            color: #667eea;
        }

        .metric-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .mini-metric {
            flex: 1;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .mini-metric-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
        }

        .mini-metric-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 18px;
        }

        .warning-banner {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="warning-banner">
            âš ï¸ MODO DEMONSTRAÃ‡ÃƒO - Usando dados simulados. Configure a API para dados reais.
        </div>

        <div class="header">
            <h1>ğŸ”¥ Sophia Bot - Dashboard Admin</h1>
            <p class="subtitle">VersÃ£o 8.2 - Anti-Spam Fix | Ãšltima atualizaÃ§Ã£o: <span id="lastUpdate">Carregando...</span></p>
            <button class="refresh-btn" onclick="loadAllData()">
                ğŸ”„ Atualizar Dados
            </button>
        </div>

        <div id="alerts"></div>

        <!-- KPIs Principais -->
        <div class="stats-grid">
            <div class="stat-card critical">
                <div class="stat-label">Taxa de ConversÃ£o VIP</div>
                <div class="stat-value" id="conversionRate">--%</div>
                <div class="stat-change" id="conversionChange">Carregando...</div>
                <div class="metric-group">
                    <div class="mini-metric">
                        <div class="mini-metric-label">Clicaram</div>
                        <div class="mini-metric-value" id="clickedVip">--</div>
                    </div>
                    <div class="mini-metric">
                        <div class="mini-metric-label">Viram Teaser</div>
                        <div class="mini-metric-value" id="sawTeaser">--</div>
                    </div>
                </div>
            </div>

            <div class="stat-card success">
                <div class="stat-label">UsuÃ¡rios Ativos</div>
                <div class="stat-value" id="totalUsers">--</div>
                <div class="stat-change" id="userGrowth">Carregando...</div>
                <div class="metric-group">
                    <div class="mini-metric">
                        <div class="mini-metric-label">Hoje</div>
                        <div class="mini-metric-value" id="activeToday">--</div>
                    </div>
                    <div class="mini-metric">
                        <div class="mini-metric-label">Esta Semana</div>
                        <div class="mini-metric-value" id="activeWeek">--</div>
                    </div>
                </div>
            </div>

            <div class="stat-card warning">
                <div class="stat-label">Engajamento MÃ©dio</div>
                <div class="stat-value" id="avgEngagement">--</div>
                <div class="stat-change" id="engagementChange">Carregando...</div>
                <div class="metric-group">
                    <div class="mini-metric">
                        <div class="mini-metric-label">Msgs/UsuÃ¡rio</div>
                        <div class="mini-metric-value" id="msgsPerUser">--</div>
                    </div>
                    <div class="mini-metric">
                        <div class="mini-metric-label">Streak MÃ©dio</div>
                        <div class="mini-metric-value" id="avgStreak">--</div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Em Cooldown</div>
                <div class="stat-value" id="cooldownUsers">--</div>
                <div class="stat-change" id="cooldownPercent">Carregando...</div>
                <div class="metric-group">
                    <div class="mini-metric">
                        <div class="mini-metric-label">Rejeitaram VIP</div>
                        <div class="mini-metric-value" id="rejectedVip">--</div>
                    </div>
                    <div class="mini-metric">
                        <div class="mini-metric-label">Ignorados</div>
                        <div class="mini-metric-value" id="ignored">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights AutomÃ¡ticos -->
        <div class="insights">
            <h3>ğŸ’¡ Insights AutomÃ¡ticos (IA)</h3>
            <div id="aiInsights">
                <p style="color: #888;">Analisando dados...</p>
            </div>
        </div>

        <!-- GrÃ¡ficos -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3>ğŸ“Š Funil de ConversÃ£o</h3>
                <canvas id="funnelChart"></canvas>
            </div>

            <div class="chart-card">
                <h3>ğŸ“ˆ Atividade dos Ãšltimos 7 Dias</h3>
                <canvas id="activityChart"></canvas>
            </div>

            <div class="chart-card">
                <h3>ğŸ”¥ NÃ­vel de Interesse (Ãšltimas 24h)</h3>
                <canvas id="interestChart"></canvas>
            </div>

            <div class="chart-card">
                <h3>â° Ofertas VIP por HorÃ¡rio</h3>
                <canvas id="hourlyChart"></canvas>
            </div>
        </div>

        <!-- Top UsuÃ¡rios -->
        <div class="table-card">
            <h3>ğŸ‘¥ Top 20 UsuÃ¡rios Mais Engajados</h3>
            <table id="topUsersTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>User ID</th>
                        <th>Mensagens</th>
                        <th>Streak</th>
                        <th>Teasers Vistos</th>
                        <th>Ãšltima Atividade</th>
                        <th>Status</th>
                        <th>Interesse</th>
                    </tr>
                </thead>
                <tbody id="topUsersBody">
                    <tr><td colspan="8" style="text-align: center; color: #888;">Carregando...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Conversas em Tempo Real -->
        <div class="table-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>ğŸ’¬ Conversas em Tempo Real</h3>
                <div>
                    <select id="conversationFilter" onchange="loadConversations()" style="padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd; margin-right: 10px;">
                        <option value="all">Todas</option>
                        <option value="hot">ğŸ”¥ Quentes</option>
                        <option value="cooldown">ğŸš« Cooldown</option>
                        <option value="converted">ğŸ’ Compraram VIP</option>
                    </select>
                    <button class="refresh-btn" onclick="loadConversations()">ğŸ”„ Atualizar</button>
                </div>
            </div>
            
            <div id="conversationsList" style="display: grid; gap: 15px;">
                <p style="text-align: center; color: #888; padding: 30px;">Carregando conversas...</p>
            </div>
        </div>

        <!-- UsuÃ¡rios em Cooldown -->
        <div class="table-card">
            <h3>ğŸš« UsuÃ¡rios em Cooldown (Rejeitaram VIP)</h3>
            <table id="cooldownTable">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Msgs Restantes no Cooldown</th>
                        <th>Ofertas VIP Hoje</th>
                        <th>Total de Teasers Vistos</th>
                        <th>Ãšltimo Contato</th>
                    </tr>
                </thead>
                <tbody id="cooldownBody">
                    <tr><td colspan="5" style="text-align: center; color: #888;">Carregando...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- AnÃ¡lise de Performance -->
        <div class="table-card">
            <h3>ğŸ“‰ AnÃ¡lise de Drop-off (Onde os leads param?)</h3>
            <table>
                <thead>
                    <tr>
                        <th>EstÃ¡gio</th>
                        <th>UsuÃ¡rios</th>
                        <th>% do Total</th>
                        <th>Drop Rate</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="dropoffBody">
                    <tr><td colspan="5" style="text-align: center; color: #888;">Carregando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let charts = {};
        let cachedData = null;
        let isLoading = false;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸš€ CARREGAMENTO ULTRA RÃPIDO - PROGRESSIVO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function loadAllData() {
            if (isLoading) return;
            isLoading = true;

            try {
                // Remove o banner de demonstraÃ§Ã£o ANTES de carregar
                document.querySelector('.warning-banner').style.display = 'none';
                console.log('ğŸ” Iniciando carregamento de dados...');
                
                // PASSO 1: Mostra dados do cache INSTANTANEAMENTE
                if (cachedData) {
                    updateKPIs(cachedData);
                    document.getElementById('lastUpdate').textContent = 'Atualizando...';
                }

                // PASSO 2: Busca dados novos (SEM timeout de 1.5s)
                const data = await fetchRealData();

                if (data) {
                    // Dados reais recebidos!
                    cachedData = data;
                    console.log('âœ… Usando dados REAIS da API');
                } else {
                    // Falhou - usa mock ou cache
                    console.log('âš ï¸ API falhou, usando dados simulados');
                    cachedData = cachedData || generateMockData();
                    document.querySelector('.warning-banner').style.display = 'block';
                }

                // PASSO 3: Atualiza em ordem de prioridade
                await updateKPIs(cachedData);
                
                // PASSO 4: Atualiza resto de forma assÃ­ncrona
                requestAnimationFrame(() => {
                    updateCharts(cachedData);
                    updateTables(cachedData);
                    generateAIInsights(cachedData);
                    updateAlerts(cachedData);
                });

                const updateText = new Date().toLocaleString('pt-BR');
                document.getElementById('lastUpdate').textContent = data ? updateText : updateText + ' (simulado)';
                
            } catch (error) {
                console.error('Erro:', error);
                const mockData = cachedData || generateMockData();
                updateKPIs(mockData);
                updateCharts(mockData);
                updateTables(mockData);
                generateAIInsights(mockData);
                updateAlerts(mockData);
                document.querySelector('.warning-banner').style.display = 'block';
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('pt-BR') + ' (simulado)';
            } finally {
                isLoading = false;
            }
        }

        async function fetchRealData() {
            try {
                // Pega o token salvo no localStorage
                const token = localStorage.getItem('adminToken');
                
                if (!token) {
                    console.error('âŒ Sem token de admin salvo');
                    return null;
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const response = await fetch('/admin/stats', {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (response.status === 401) {
                    console.error('âŒ Token invÃ¡lido - redirecionando para login');
                    localStorage.removeItem('adminToken');
                    window.location.href = '/admin/login';
                    return null;
                }

                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… Dados recebidos da API');
                    return data;
                }
                
                console.error('âŒ Erro na resposta:', response.status);
                return null;
            } catch (error) {
                console.error('âŒ Erro ao buscar dados:', error);
                return null;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // âš¡ ATUALIZAÃ‡ÃƒO ULTRA RÃPIDA DOS KPIs (PRIORIDADE MÃXIMA)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function updateKPIs(data) {
            requestAnimationFrame(() => {
                const conversionRate = data.stats.sawTeaser > 0 
                    ? (data.stats.clickedVip / data.stats.sawTeaser * 100).toFixed(1)
                    : 0;
                document.getElementById('conversionRate').textContent = `${conversionRate}%`;
                document.getElementById('conversionChange').textContent = 
                    `${data.stats.clickedVip} de ${data.stats.sawTeaser} converteram`;
                document.getElementById('clickedVip').textContent = data.stats.clickedVip;
                document.getElementById('sawTeaser').textContent = data.stats.sawTeaser;

                document.getElementById('totalUsers').textContent = data.stats.totalUsers;
                document.getElementById('userGrowth').textContent = `+${data.stats.newUsers24h} nas Ãºltimas 24h`;
                document.getElementById('activeToday').textContent = data.stats.activeToday;
                document.getElementById('activeWeek').textContent = data.stats.activeWeek;

                const avgMsgs = (data.stats.totalMessages / data.stats.totalUsers).toFixed(1);
                document.getElementById('avgEngagement').textContent = `${avgMsgs} msgs`;
                document.getElementById('msgsPerUser').textContent = avgMsgs;
                document.getElementById('avgStreak').textContent = `${data.stats.avgStreak} dias`;

                document.getElementById('cooldownUsers').textContent = data.stats.inCooldown;
                const cooldownPercent = (data.stats.inCooldown / data.stats.totalUsers * 100).toFixed(1);
                document.getElementById('cooldownPercent').textContent = `${cooldownPercent}% do total`;
                document.getElementById('rejectedVip').textContent = data.stats.rejectedVip;
                document.getElementById('ignored').textContent = data.stats.ignored;
            });
        }

        function updateCharts(data) {
            Chart.defaults.animation = false;
            
            const renderCharts = () => {
                // Funil
                if (charts.funnel) charts.funnel.destroy();
                const funnelCtx = document.getElementById('funnelChart').getContext('2d');
                charts.funnel = new Chart(funnelCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Iniciaram', '1Âª Msg', 'Teaser', 'VIP'],
                        datasets: [{
                            label: 'UsuÃ¡rios',
                            data: [
                                data.funnel.started,
                                data.funnel.firstMessage,
                                data.funnel.sawTeaser,
                                data.funnel.clickedVip
                            ],
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(118, 75, 162, 0.8)',
                                'rgba(240, 147, 251, 0.8)',
                                'rgba(245, 87, 108, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });

                // Atividade
                if (charts.activity) charts.activity.destroy();
                const activityCtx = document.getElementById('activityChart').getContext('2d');
                charts.activity = new Chart(activityCtx, {
                    type: 'line',
                    data: {
                        labels: data.activity.labels,
                        datasets: [{
                            label: 'Mensagens',
                            data: data.activity.messages,
                            borderColor: 'rgba(102, 126, 234, 1)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } }
                    }
                });

                // Interesse
                if (charts.interest) charts.interest.destroy();
                const interestCtx = document.getElementById('interestChart').getContext('2d');
                charts.interest = new Chart(interestCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Alto', 'MÃ©dio', 'Baixo'],
                        datasets: [{
                            data: [data.interest.high, data.interest.medium, data.interest.low],
                            backgroundColor: [
                                'rgba(245, 87, 108, 0.8)',
                                'rgba(255, 152, 0, 0.8)',
                                'rgba(33, 150, 243, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true
                    }
                });

                // HorÃ¡rios
                if (charts.hourly) charts.hourly.destroy();
                const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
                charts.hourly = new Chart(hourlyCtx, {
                    type: 'line',
                    data: {
                        labels: data.hourly.labels,
                        datasets: [{
                            label: 'Ofertas VIP',
                            data: data.hourly.offers,
                            borderColor: 'rgba(118, 75, 162, 1)',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } }
                    }
                });
            };

            if ('requestIdleCallback' in window) {
                requestIdleCallback(renderCharts, { timeout: 1000 });
            } else {
                requestAnimationFrame(renderCharts);
            }
        }

        function updateTables(data) {
            requestAnimationFrame(() => {
                // Top Users
                const topUsersBody = document.getElementById('topUsersBody');
                const fragment = document.createDocumentFragment();
                
                data.topUsers.forEach((user, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.id}</td>
                        <td>${user.messages}</td>
                        <td>${user.streak} ğŸ”¥</td>
                        <td>${user.teasers}</td>
                        <td>${user.lastActivity}</td>
                        <td><span class="badge ${user.status}">${user.statusText}</span></td>
                        <td><span class="badge ${user.interest}">${user.interestText}</span></td>
                    `;
                    fragment.appendChild(tr);
                });
                
                topUsersBody.innerHTML = '';
                topUsersBody.appendChild(fragment);

                // Cooldown
                const cooldownBody = document.getElementById('cooldownBody');
                if (data.cooldownUsers.length === 0) {
                    cooldownBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #888;">Nenhum usuÃ¡rio em cooldown</td></tr>';
                } else {
                    const fragment2 = document.createDocumentFragment();
                    data.cooldownUsers.forEach(user => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${user.id}</td>
                            <td>${user.cooldownRemaining} msgs</td>
                            <td>${user.offersToday}</td>
                            <td>${user.totalTeasers}</td>
                            <td>${user.lastContact}</td>
                        `;
                        fragment2.appendChild(tr);
                    });
                    cooldownBody.innerHTML = '';
                    cooldownBody.appendChild(fragment2);
                }

                // Dropoff
                const dropoffBody = document.getElementById('dropoffBody');
                const fragment3 = document.createDocumentFragment();
                data.dropoff.forEach(stage => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${stage.name}</td>
                        <td>${stage.users}</td>
                        <td>${stage.percent}%</td>
                        <td><span class="badge ${stage.dropClass}">${stage.dropRate}%</span></td>
                        <td>${stage.status}</td>
                    `;
                    fragment3.appendChild(tr);
                });
                dropoffBody.innerHTML = '';
                dropoffBody.appendChild(fragment3);
            });
        }

        function generateAIInsights(data) {
            const insights = [];

            const conversionRate = (data.stats.clickedVip / data.stats.sawTeaser * 100);
            if (conversionRate < 10) {
                insights.push(`<strong>âš ï¸ Taxa de conversÃ£o BAIXA (${conversionRate.toFixed(1)}%)</strong> - Considere: melhorar urgÃªncia, testar novos teasers, ou ajustar timing das ofertas.`);
            } else if (conversionRate > 25) {
                insights.push(`<strong>ğŸ¯ Taxa de conversÃ£o EXCELENTE (${conversionRate.toFixed(1)}%)</strong> - Continue com essa estratÃ©gia! Considere aumentar trÃ¡fego.`);
            }

            const cooldownRate = (data.stats.inCooldown / data.stats.totalUsers * 100);
            if (cooldownRate > 30) {
                insights.push(`<strong>ğŸš¨ ${cooldownRate.toFixed(1)}% dos usuÃ¡rios em cooldown</strong> - Bot pode estar sendo muito insistente. Considere aumentar o intervalo entre ofertas.`);
            }

            const avgMsgs = data.stats.totalMessages / data.stats.totalUsers;
            if (avgMsgs < 5) {
                insights.push(`<strong>ğŸ“‰ Engajamento BAIXO (${avgMsgs.toFixed(1)} msgs/usuÃ¡rio)</strong> - UsuÃ¡rios abandonam rÃ¡pido. Melhore as respostas da IA ou o onboarding.`);
            } else if (avgMsgs > 15) {
                insights.push(`<strong>ğŸ”¥ Engajamento ALTO (${avgMsgs.toFixed(1)} msgs/usuÃ¡rio)</strong> - UsuÃ¡rios estÃ£o muito engajados! Ã“timo sinal de product-market fit.`);
            }

            const bestHour = data.hourly.offers.indexOf(Math.max(...data.hourly.offers));
            insights.push(`<strong>â° Melhor horÃ¡rio:</strong> ${data.hourly.labels[bestHour]} - Concentre esforÃ§os de marketing nesse perÃ­odo.`);

            const biggestDrop = data.dropoff.reduce((max, stage) => 
                parseFloat(stage.dropRate) > parseFloat(max.dropRate) ? stage : max
            );
            if (parseFloat(biggestDrop.dropRate) > 50) {
                insights.push(`<strong>âš ï¸ Maior drop-off: ${biggestDrop.name} (${biggestDrop.dropRate}%)</strong> - Foque em melhorar essa etapa do funil.`);
            }

            const insightsDiv = document.getElementById('aiInsights');
            insightsDiv.innerHTML = insights.map(i => `<div class="insight-item">${i}</div>`).join('');
        }

        function updateAlerts(data) {
            const alertsDiv = document.getElementById('alerts');
            const alerts = [];

            if (data.stats.clickedVip === 0) {
                alerts.push('<div class="alert danger"><strong>ğŸš¨ CRÃTICO:</strong> Nenhuma conversÃ£o VIP ainda! Verifique se o link do canal estÃ¡ correto.</div>');
            }

            const conversionRate = (data.stats.clickedVip / data.stats.sawTeaser * 100);
            if (conversionRate < 5 && data.stats.sawTeaser > 20) {
                alerts.push('<div class="alert danger"><strong>âš ï¸ ATENÃ‡ÃƒO:</strong> Taxa de conversÃ£o muito baixa. Considere revisar a oferta VIP ou os teasers.</div>');
            }

            if (data.stats.activeToday < data.stats.totalUsers * 0.1) {
                alerts.push('<div class="alert"><strong>ğŸ“‰ ALERTA:</strong> Poucos usuÃ¡rios ativos hoje. Considere enviar mensagens de reengajamento.</div>');
            }

            alertsDiv.innerHTML = alerts.join('');
        }

        function generateMockData() {
            return {
                stats: {
                    totalUsers: 1247,
                    newUsers24h: 183,
                    activeToday: 421,
                    activeWeek: 876,
                    sawTeaser: 543,
                    clickedVip: 87,
                    totalMessages: 18934,
                    avgStreak: 3.2,
                    inCooldown: 124,
                    rejectedVip: 89,
                    ignored: 35
                },
                funnel: {
                    started: 1247,
                    firstMessage: 1089,
                    sawTeaser: 543,
                    clickedVip: 87
                },
                activity: {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'SÃ¡b', 'Dom'],
                    messages: [2340, 2890, 3120, 2750, 3450, 2980, 2100]
                },
                interest: {
                    high: 234,
                    medium: 512,
                    low: 501
                },
                hourly: {
                    labels: ['0h', '2h', '4h', '6h', '8h', '10h', '12h', '14h', '16h', '18h', '20h', '22h'],
                    offers: [12, 8, 5, 7, 15, 23, 34, 45, 56, 67, 78, 54]
                },
                topUsers: Array.from({length: 20}, (_, i) => ({
                    id: 1000000 + Math.floor(Math.random() * 1000000),
                    messages: Math.floor(Math.random() * 100) + 20,
                    streak: Math.floor(Math.random() * 10),
                    teasers: Math.floor(Math.random() * 5),
                    lastActivity: `${Math.floor(Math.random() * 24)}h atrÃ¡s`,
                    status: ['hot', 'warm', 'cold'][Math.floor(Math.random() * 3)],
                    statusText: ['ğŸ”¥ Quente', 'ğŸ˜Š Morno', 'â„ï¸ Frio'][Math.floor(Math.random() * 3)],
                    interest: ['hot', 'warm', 'cold'][Math.floor(Math.random() * 3)],
                    interestText: ['Alto', 'MÃ©dio', 'Baixo'][Math.floor(Math.random() * 3)]
                })),
                cooldownUsers: Array.from({length: 5}, (_, i) => ({
                    id: 2000000 + Math.floor(Math.random() * 1000000),
                    cooldownRemaining: Math.floor(Math.random() * 8) + 1,
                    offersToday: Math.floor(Math.random() * 3) + 1,
                    totalTeasers: Math.floor(Math.random() * 5) + 1,
                    lastContact: `${Math.floor(Math.random() * 12)}h atrÃ¡s`
                })),
                dropoff: [
                    { name: 'Start â†’ 1Âª Msg', users: 158, percent: 87.3, dropRate: '12.7', dropClass: 'warm', status: 'âœ… Normal' },
                    { name: '1Âª Msg â†’ Teaser', users: 546, percent: 49.9, dropRate: '50.1', dropClass: 'hot', status: 'âš ï¸ Alto' },
                    { name: 'Teaser â†’ Clique VIP', users: 456, percent: 16.0, dropRate: '84.0', dropClass: 'hot', status: 'ğŸš¨ CrÃ­tico' }
                ]
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ’¬ CONVERSAS EM TEMPO REAL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        async function loadConversations() {
            const filter = document.getElementById('conversationFilter').value;
            
            try {
                const token = localStorage.getItem('adminToken');
                if (!token) return;

                const response = await fetch(`/admin/conversations?filter=${filter}`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('Erro ao carregar conversas');
                    return;
                }

                const data = await response.json();
                displayConversations(data.conversations);
                
            } catch (error) {
                console.error('Erro:', error);
            }
        }

        function displayConversations(conversations) {
            const container = document.getElementById('conversationsList');
            
            if (conversations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 30px;">Nenhuma conversa ativa nas Ãºltimas 24h</p>';
                return;
            }

            container.innerHTML = conversations.map(conv => `
                <div style="background: #f9f9f9; border-radius: 10px; padding: 15px; border-left: 4px solid ${getStatusColor(conv.statusClass)};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <strong style="font-size: 16px;">User ${conv.userId}</strong>
                            <span class="badge ${conv.statusClass}" style="margin-left: 10px;">${conv.status}</span>
                        </div>
                        <div style="text-align: right; font-size: 13px; color: #666;">
                            <div>ğŸ“Š ${conv.totalMessages} mensagens</div>
                            <div>â° ${conv.lastActivity} atrÃ¡s</div>
                            ${conv.teaserCount > 0 ? `<div>ğŸ‘€ ${conv.teaserCount} teasers</div>` : ''}
                        </div>
                    </div>
                    
                    <div style="background: white; border-radius: 8px; padding: 12px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; line-height: 1.6;">
                        ${conv.messages.length > 0 
                            ? conv.messages.map(msg => {
                                const isUser = msg.includes('USER:');
                                const isMaya = msg.includes('MAYA:');
                                const isSystem = msg.includes('SYSTEM:') || msg.includes('ACTION:');
                                
                                let color = '#333';
                                let icon = 'ğŸ’¬';
                                
                                if (isUser) {
                                    color = '#2196f3';
                                    icon = 'ğŸ‘¤';
                                } else if (isMaya) {
                                    color = '#e91e63';
                                    icon = 'ğŸ’‹';
                                } else if (isSystem) {
                                    color = '#9e9e9e';
                                    icon = 'âš™ï¸';
                                }
                                
                                return `<div style="color: ${color}; margin: 4px 0;">${icon} ${msg}</div>`;
                            }).join('')
                            : '<div style="color: #999;">Nenhuma mensagem ainda</div>'
                        }
                    </div>
                </div>
            `).join('');
        }

        function getStatusColor(statusClass) {
            const colors = {
                'vip': '#4CAF50',
                'hot': '#f44336',
                'cooldown': '#ff9800',
                'normal': '#2196f3'
            };
            return colors[statusClass] || '#666';
        }

        // Auto-refresh das conversas a cada 10 segundos
        setInterval(loadConversations, 10000);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // âš¡ AUTO-REFRESH INTELIGENTE (sÃ³ atualiza se aba visÃ­vel)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let refreshInterval;
        
        function startAutoRefresh() {
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    clearInterval(refreshInterval);
                } else {
                    loadAllData();
                    refreshInterval = setInterval(loadAllData, 30000);
                }
            });

            refreshInterval = setInterval(loadAllData, 30000);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸš€ INICIALIZAÃ‡ÃƒO ULTRA RÃPIDA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                loadAllData();
                loadConversations();
                startAutoRefresh();
            });
        } else {
            loadAllData();
            loadConversations();
            startAutoRefresh();
        }
    </script>
</body>
</html>
